<!-- =========================================================== -->
<!--  README.md ‚Äì Connect-People (Back-end Node/TypeScript)        -->
<!--  Version √©quipe ‚Äì comment√©e ligne par ligne                   -->
<!--  Derni√®re maj : 26/08/2025                                  -->
<!-- =========================================================== -->

# üöÄ Connect-People ‚Äì API & Back-office

> Backend Node.js/Express en **ES2022 (ESM)** pour la plate-forme **Connect-People**.  
> Cible : authentification double-r√¥le (user + admin), gestion de contenu (chat, vid√©os, photos, voix), signalement, 2FA, CSRF, rate-limit, i18n et Redis.

---

## üì¶ 1. Pr√©requis

| Logiciel | Version minimum | Pourquoi ? |
|---|---|---|
| Node.js | 18.x | Support natif ESM + top-level await |
| MySQL | 8.0 | utf8mb4, JSON, transactions |
| Redis | 6.x | Sessions, cache, rate-limit |

---

## üèÅ 2. Installation rapide (copier-coller dans le terminal)

```bash
# 1. R√©cup√©ration
git clone https://github.com/<votre-org>/connect-people.git
cd connect-people

# 2. D√©pendances
npm install            # installe node_modules √† la racine

# 3. Variables d‚Äôenv
cp .env.example .env   # puis √©diter avec vos infos MySQL/Redis

# 4. Base de donn√©es
mysql -u root -p -e "CREATE DATABASE connect_people CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;"

# 5. Lancement dev
npm run dev            # tsx watch ‚Üí http://localhost:4000

‚öôÔ∏è 3. Scripts npm expliqu√©s

| Script               | Ce qu‚Äôil fait vraiment                  |
| -------------------- | --------------------------------------- |
| `npm run dev`        | tsx watch ‚Üí recharge auto √† chaque save |
| `npm run build`      | tsc ‚Üí g√©n√®re `dist/` (prod ready)       |
| `npm start`          | node dist/index.js (apr√®s build)        |
| `npm test`           | Jest en mode CI                         |
| `npm run test:watch` | Jest --watch pendant le dev             |


üîê 4. Variables d‚Äôenvironnement (obligatoires)

    Copier .env.example ‚Üí .env puis remplir.
    Les secrets doivent √™tre diff√©rents entre JWT_ADMIN_* et JWT_USER_*.

    # === Serveur ===
PORT=4000
FRONT_URL=http://localhost:5173      # CORS

# === MySQL ===
DB_HOST=localhost
DB_PORT=3306
DB_NAME=connect_people
DB_USER=root
DB_PASSWORD=********

# === Redis ===
REDIS_URL=redis://localhost:6379

# === JWT ===
JWT_ADMIN_ACCESS_SECRET=change_me_admin_access
JWT_ADMIN_REFRESH_SECRET=change_me_admin_refresh
JWT_USER_ACCESS_SECRET=change_me_user_access
JWT_USER_REFRESH_SECRET=change_me_user_refresh

# === Mail (nodemailer) ===
MAIL_HOST=smtp.gmail.com
MAIL_PORT=587
MAIL_USER=your_email@gmail.com
MAIL_PASS=your_app_password

# === IP Whitelist admin (CIDR) ===
ADMIN_IP_WHITELIST=203.0.113.42,10.8.0.0/24

üóÇÔ∏è 5. Arborescence comment√©e

src/
‚îú‚îÄ‚îÄ client/              # Code **front** (localStorage, Axios) ‚Äì ignor√© par tsc
‚îú‚îÄ‚îÄ config/              # Configs pures (pas de logique)
‚îÇ   ‚îú‚îÄ‚îÄ database.ts      # Pool MySQL natif + Sequelize
‚îÇ   ‚îú‚îÄ‚îÄ csrfConfig.ts    # CSRF tokens & erreurs
‚îÇ   ‚îú‚îÄ‚îÄ i18n.ts          # Internationalisation (8 langues)
‚îÇ   ‚îî‚îÄ‚îÄ env.ts           # Validation stricte des vars d‚Äôenv
‚îú‚îÄ‚îÄ controllers/         # Logique m√©tier (vide pour l‚Äôinstant)
‚îú‚îÄ‚îÄ locales/             # Fichiers JSON de traduction
‚îú‚îÄ‚îÄ middlewares/         # Cha√Æne Express
‚îÇ   ‚îú‚îÄ‚îÄ admin/           # Authent + IP + RBAC admin
‚îÇ   ‚îú‚îÄ‚îÄ user/            # Authent + RBAC user
‚îÇ   ‚îî‚îÄ‚îÄ validate.ts      # Validation Zod des bodies
‚îú‚îÄ‚îÄ models/              # Sch√©mas Sequelize
‚îú‚îÄ‚îÄ routes/              # Regroupement par ¬´ scope ¬ª
‚îÇ   ‚îú‚îÄ‚îÄ admin/           # Routes back-office
‚îÇ   ‚îú‚îÄ‚îÄ api/             # Routes publiques /api/v1
‚îÇ   ‚îú‚îÄ‚îÄ user/            # Routes utilisateur
‚îÇ   ‚îî‚îÄ‚îÄ web/             # Routes SSR (CSRF, i18n)
‚îú‚îÄ‚îÄ services/            # Acc√®s aux donn√©es (Redis, mail, s√©curit√©)
‚îú‚îÄ‚îÄ utils/               # Helpers DB & signalements
‚îú‚îÄ‚îÄ __tests__/           # Tests Jest
‚îî‚îÄ‚îÄ index.ts             # Point d‚Äôentr√©e unique

üö™ 6. Endpoints disponibles

| Verbe  | Endpoint              | Authent | Description          | Middlewares actifs  |
| ------ | --------------------- | ------- | -------------------- | ------------------- |
| `POST` | `/admin/auth/login`   | ‚ùå       | Login admin + 2FA    | IP whitelist, Zod   |
| `POST` | `/user/auth/register` | ‚ùå       | Cr√©ation compte user | Zod                 |
| `POST` | `/user/auth/login`    | ‚ùå       | Login user           | Zod                 |
| `GET`  | `/admin/reports`      | ‚úÖ admin | Liste signalements   | `authenticateAdmin` |
| `POST` | `/api/v1/report`      | ‚úÖ user  | Signaler un contenu  | `authenticateUser`  |
| `GET`  | `/`                   | ‚ùå       | Page d‚Äôaccueil SSR   | CSRF, i18n          |


üîí 7. S√©curit√© ‚Äì m√©canismes & fichiers

| Risque                 | Solution                              | Fichier(s) cl√©s                           |
| ---------------------- | ------------------------------------- | ----------------------------------------- |
| Brute-force login      | Tentatives stock√©es en Redis (15 min) | `services/security.service.ts`            |
| CSRF                   | Token unique par session              | `config/csrfConfig.ts`                    |
| Rate-limit global      | 100 req / 15 min par IP               | `services/rateLimit.ts`                   |
| IP admin non autoris√©e | Liste blanche CIDR                    | `middlewares/admin/adminIP.middleware.ts` |
| JWT compromis          | Secrets s√©par√©s admin/user            | `.env`                                    |
| Injection SQL          | Requ√™tes pr√©par√©es (mysql2/Sequelize) | `utils/db.ts`                             |


üß™ 8. Tests

# Tous les tests
npm test

# Uniquement le fichier en cours d‚Äô√©dition
npm run test:watch

Ajouter vos fichiers de test dans __tests__/**/*.test.ts.
Jest est d√©j√† configur√© en ESM via ts-jest.

üó£Ô∏è 9. Internationalisation

    Les cl√©s de traduction sont dans src/locales/*.json.
    Langue par d√©faut : fr.
    Changer via cookie lang=es ou header Accept-Language: de.

Exemple de cl√© dans un contr√¥leur :

res.send(req.__('welcome')); // renverra "Bienvenue" ou la traduction


üìà 10. Logs

Winston est install√© mais non encore branch√© (√† faire).
Structure pr√©vue :

import logger from './services/logger';
logger.info('User logged in', { userId });


ü§ù 11. Contribution (workflow Git)

    Cr√©er une branche feature/nom-du-ticket
    Commits en Conventional Commits :

    feat(auth): ajoute refresh token sliding
fix(report): corrige crash si evidence manquant

Push + PR ‚Üí review ‚Üí merge sur main
D√©ploiement auto via CI (GitHub Actions √† venir)

üìÑ 12. Licence

MIT ‚Äì ¬© 2025 MLB & √âquipe Connect-People.
Vous √™tes libres d‚Äôutiliser, modifier et redistribuer tant que la licence MIT est conserv√©e.
üìé Annexe ‚Äì Liste brute des fichiers sources

.env.example
jest.config.js
package.json
tsconfig.json
tsconfig.build.json
src/
  client/storage.ts
  config/adminRoles.ts
  config/axiosConfig.ts
  config/csrfConfig.ts
  config/database.ts
  config/env.ts
  config/i18n.ts
  config/userRoles.ts
  controllers/admin.controller.ts
  controllers/user.controller.ts
  locales/ar.json
  locales/de.json
  locales/en.json
  locales/es.json
  locales/fr.json
  locales/it.json
  locales/pt.json
  middlewares/admin/adminIP.middleware.ts
  middlewares/admin/authenticateAdmin.ts
  middlewares/admin/authorizeAdmin.ts
  middlewares/user/authenticateUser.ts
  middlewares/user/authorizeUser.ts
  middlewares/csrf.ts
  middlewares/slidingRefresh.ts
  middlewares/validate.ts
  models/report.model.ts
  routes/admin/auth.routes.ts
  routes/admin/reports.routes.ts
  routes/api/report.routes.ts
  routes/user/auth.routes.ts
  routes/web/index.ts
  services/rateLimit.ts
  services/redis.service.ts
  services/security.service.ts
  utils/db.ts
  utils/report.ts
  index.ts

   

  ###13 / üîê JWT_CONFIG ‚Äì module de configuration centralis√©e

**Fichier :** `src/config/jwt.config.ts`

| Export         | Utilisation                                                         |
|----------------|----------------------------------------------------------------------|
| `JWT_CONFIG`   | Objet **immutable** regroupant :                                    |
|                | ‚Ä¢ `secrets` ‚Äì secrets JWT admin & user (lues dans `.env`)           |
|                | ‚Ä¢ `expiry` ‚Äì dur√©es de vie des tokens (re-export√©es depuis `adminRoles.ts`) |
|                | ‚Ä¢ `cookie` ‚Äì options de cookie s√©curis√©es (re-export√©es depuis `adminRoles.ts`) |
|                | ‚Ä¢ `algorithm` ‚Äì algo de signature (`HS256`)                         |

**Importation :**
```ts
import { JWT_CONFIG } from './config/jwt.config';

Exemples d‚Äôusage :

// Middleware d‚Äôauthentification
const payload = jwt.verify(token, JWT_CONFIG.secrets.adminAccess);

// Pose d‚Äôun refresh token
res.cookie('rt', refreshToken, { ...JWT_CONFIG.cookie, maxAge: 7 * 24 * 60 * 60 * 1000 });

‚úÖ Z√©ro duplication : toutes les valeurs proviennent d√©j√† de adminRoles.ts et de l‚Äôenvironnement.

###14) üîç Audit administrateur ‚Äì middleware global

**Fichier concern√© :** `src/index.ts`

Un middleware Express plac√© **une seule fois** apr√®s le `slidingRefresh` intercepte **toutes les requ√™tes commen√ßant par `/admin/‚Ä¶`** :

```ts
app.use('/admin', slidingRefresh('JWT_ADMIN_REFRESH_SECRET'));
app.use('/admin', (req, _res, next) => {
  if (req.admin) {
    log.admin('view_access', req.admin.email, { view: req.originalUrl });
  }
  next();
});

| Champ      | Contenu                                     |
| ---------- | ------------------------------------------- |
| `scope`    | `admin`                                     |
| `action`   | `view_access`                               |
| `username` | `req.admin.email` (l‚Äôadmin connect√©)        |
| `view`     | `req.originalUrl` (page r√©ellement acc√©d√©e) |

üìÅ Logs produits

    Fichier console : couleurs visuelles pendant le d√©veloppement.
    Fichier rotatif : logs/app-YYYY-MM-DD.log (jusqu‚Äô√† 20 Mo, 14 jours de r√©tention).
    Fichier erreur : logs/error-YYYY-MM-DD.log (m√™me rotation, uniquement niveau error).

    üõ†Ô∏è Utilisation simplifi√©e
Dans n‚Äôimporte quel fichier :

import { log } from './services/logger.service';

log.admin('login', 'alice', { ip: '203.0.113.42' });
log.user('password_change', 'bob', { method: 'email' });

Aucune autre configuration requise ; le dossier logs/ est cr√©√© automatiquement au premier log.

###15) üì° Middleware de notification multi-plateforme

**Fichier :** `src/middlewares/notification.middleware.ts`

Ce middleware **intercepte automatiquement** la fin des requ√™tes r√©ussies (statut 200) et d√©clenche des notifications **asynchrones** via les services suivants :

| Plateforme       | Service cible (√† brancher)                            |
|------------------|--------------------------------------------------------|
| Socket.IO        | `io.emit(...)` ‚Äì diffusion temps r√©el Web / Mobile     |
| Email            | `sendMail(...)` ‚Äì service Brevo d√©j√† cr√©√©              |
| Push             | `sendPushNotification(...)` ‚Äì service √† venir          |

---

### üéØ Middlewares export√©s

| Nom                     | D√©clench√© sur                         | Donn√©es utilis√©es (req)                                  |
|-------------------------|---------------------------------------|----------------------------------------------------------|
| `notifyNewVoiceMessage` | Fin d‚Äôune requ√™te de message vocal    | `user.id`, `user.email`, `newMessageId`                  |
| `notifyNewAlert`        | Fin d‚Äôune requ√™te d‚Äôalerte            | `user.id`, `user.email`, `newAlertId`, `body.alertType`  |

---

### üß© Utilisation

Ajoute simplement le middleware sur la route concern√©e :

```ts
import { notifyNewVoiceMessage } from './middlewares/notification.middleware';

router.post('/voice', authenticateUser, notifyNewVoiceMessage, voiceController);

Le middleware n‚Äôattend rien et ne bloque pas la r√©ponse client ; il travaille en arri√®re-plan d√®s que res.statusCode === 200.

### 16 S√©curit√© renforc√©e (ADMIN uniquement)
Dossier concern√© : src/middlewares/admin/ et src/services/security.service.ts
Acteur vis√© : ADMINISTRATEUR uniquement ‚Äì aucun impact sur les utilisateurs classiques.
Objectif
Centraliser et appliquer uniquement aux routes commen√ßant par /admin/... un ensemble de v√©rifications de s√©curit√© tr√®s strictes :

    Authentification multi-facteurs (MFA) obligatoire.
    Code de confirmation √† usage unique (stock√© en session).
    Adresse IP restreinte :
    ‚Ä¢ liste blanche CIDR (variable d‚Äôenv IP_WHITELIST) OU IP locale autoris√©e.
    Heures ouvrables : 09 h ‚Äì 18 h (fuseau serveur).
    RBAC : r√¥le president ou admin selon l‚Äôaction.
        Rate-limit global (Redis) : 100 requ√™tes / 15 min par IP.

Utilisation
‚Ä¢ Le middleware sensitiveAction.middleware.ts encapsule toutes ces v√©rifications.
‚Ä¢ Il est mont√© exclusivement sur les routes admin ; les routes /user/... ou /api/v1/... ne le traversent jamais.
‚Ä¢ Aucune configuration c√¥t√© utilisateur n‚Äôest n√©cessaire ‚Äì l‚Äôexp√©rience utilisateur reste inchang√©e.
Structure

src/
‚îú‚îÄ‚îÄ services/security.service.ts      # fonctions utilitaires partag√©es
‚îî‚îÄ‚îÄ middlewares/admin/
    ‚îú‚îÄ‚îÄ sensitiveAction.middleware.ts # middleware composite (MFA, IP, horaires‚Ä¶)
    ‚îî‚îÄ‚îÄ separationPrivileges.middleware.ts # RBAC sp√©cifique aux actions sensibles

    ### 17) adminToken.service.ts ‚Äì G√©n√©ration & v√©rification des tokens administrateur

| Export                                | Description                                        |
| ------------------------------------- | -------------------------------------------------- |
| `generateAdminAccessToken(id, role)`  | JWT court (15 min) pour acc√®s API.                 |
| `generateAdminRefreshToken(id, role)` | JWT long (7 j) pour renouvellement + `jti` unique. |
| `verifyAdminAccessToken(token)`       | V√©rifie & d√©code le token court.                   |
| `verifyAdminRefreshToken(token)`      | V√©rifie & d√©code le token long.                    |
| `generateAdminCSRFToken()`            | G√©n√®re un token CSRF al√©atoire (32 bytes).         |
| `verifyAdminCSRFToken(token, stored)` | Comparaison timing-safe CSRF.                      |


‚öôÔ∏è Variables requises :
JWT_ADMIN_ACCESS_SECRET, JWT_ADMIN_REFRESH_SECRET dans .env

### 18)  redis.service.ts ‚Äì Client Redis & store Express-Session

| Export           | Description                                            |
| ---------------- | ------------------------------------------------------ |
| `redis`          | Client Redis d√©j√† connect√© (singleton).                |
| `connectRedis()` | Appel unique au boot ‚Üí `await connectRedis()`.         |
| `sessionStore`   | Store pr√™t pour `express-session` (`connect-redis@7`). |


Configuration par d√©faut :

    Host : REDIS_URL (.env) ou redis://localhost:6379
    Pr√©fixe cl√©s : sess:
    TTL : 24 h

    ###  19) rbacAction.middleware.ts ‚Äì Contr√¥le d‚Äôacc√®s RBAC administrateur

    Middleware Express utilisable uniquement sur les routes admin.

    import { rbacAction } from './middlewares/admin/rbacAction.middleware';

router.delete(
  '/users/:id',
  authenticateAdmin,
  rbacAction('users', 3),  // seul pr√©sident ou r√¥le ‚â• 3
  deleteUserController
);

| Param√®tre  | Type                                 | D√©tail                                                |
| ---------- | ------------------------------------ | ----------------------------------------------------- |
| `resource` | `keyof PERMISSION_MATRIX[AdminRole]` | Domaine (`users`, `finance`, `security`‚Ä¶).            |
| `level`    | `number`                             | Niveau minimum (1-3) d√©fini dans `PERMISSION_MATRIX`. |

R√©ponses :

    200 ‚Üí acc√®s accord√©.
    403 ROLE_UNKNOWN ‚Üí r√¥le absent ou invalide.
    403 RBAC_DENIED ‚Üí niveau insuffisant (loggu√©).

    import { connectRedis } from './services/redis.service.js';
      await connectRedis(); // avant app.use(session(...))

  Arborescence simplifi√©e

  src/services/
‚îú‚îÄ‚îÄ adminToken.service.ts    # tokens + CSRF
‚îî‚îÄ‚îÄ redis.service.ts         # client + store Redis
src/middlewares/admin/
‚îî‚îÄ‚îÄ rbacAction.middleware.ts # RBAC admin




### 20) # ‚Äì Turnstile + Rate-Limit

Int√©gration de **Cloudflare Turnstile** et du **rate-limit Redis** dans l‚Äôarchitecture existante.
#  PAS ENCORE CONNECTER A TURNSTILLE
#  Pr√©requis (une seule fois)
# ‚Ä¢ Compte Cloudflare (gratuit)
# ‚Ä¢ Dashboard Turnstile ‚Üí ¬´ Add Site ¬ª ‚Üí Mode ¬´ Managed ¬ª ‚Üí copier les 2 cl√©s :
# ‚Äì Site Key (publique)
# ‚Äì Secret Key (serveur)


---

## 3. Installation rapide

1. Cr√©er un site Turnstile dans Cloudflare ‚Üí copier **Site Key** et **Secret Key**.  
2. Ajouter dans `.env` :

TURNSTILE_SECRET=0x4AAAA....
TURNSTILE_SITEKEY=0x4AAAA....


3. Installer le script Turnstile c√¥t√© front (voir `index.html` fourni).  
4. Dans chaque route √† prot√©ger, ins√©rer `turnstileGuard` **juste avant le contr√¥leur** :

```ts
router.post('/login', validate(schema), turnstileGuard, loginController);

---

## 1. Principe

1. **Front** : un script Turnstile g√©n√®re un token cach√© (invisible).  
2. **Back** :  
   ‚Ä¢ `turnstile.middleware.ts`  
   ‚Äì V√©rifie le rate-limit (Redis)  
   ‚Äì V√©rifie le token aupr√®s de Cloudflare  
   ‚Äì Passe ou rejette la requ√™te.  
3. **Routes prot√©g√©es** : ajout d‚Äôun simple `turnstileGuard` dans la pile des middlewares.

---
src/
‚îú‚îÄ services/
‚îÇ   ‚îú‚îÄ redis.service.ts        # Client Redis (d√©j√† existant)
‚îÇ   ‚îú‚îÄ rateLimitService.ts     # logique ¬´ hit / reset ¬ª (d√©j√† existant)
‚îÇ   ‚îî‚îÄ turnstile.service.ts    # V√©rification serveur Turnstile (nouveau)
‚îú‚îÄ middlewares/
‚îÇ   ‚îî‚îÄ turnstile.middleware.ts # Middleware Express ¬´ cl√©-en-main ¬ª (nouveau)
‚îú‚îÄ routes/
‚îÇ   ‚îú‚îÄ user/auth.routes.ts         # login utilisateur (modifi√© : + turnstileGuard)
‚îÇ   ‚îú‚îÄ admin/auth.routes.ts        # login admin (modifi√© : + turnstileGuard)
‚îÇ   ‚îú‚îÄ admin/sensitive.routes.ts   # actions sensibles (modifi√© : + turnstileGuard)
‚îÇ   ‚îî‚îÄ admin/users.routes.ts       # cr√©ation user (modifi√© : + turnstileGuard)
‚îî‚îÄ types/
‚îî‚îÄ turnstile.d.ts          # Typage TypeScript (facultatif)

### 21) les r√®gles et valeurs par d√©faut utilis√©es pour les JWT d‚Äôacc√®s, refresh, reset et CSRF.
# Les dur√©es sont centralis√©es dans le fichier src/config/tokens.ts :

| Type de token      | Dur√©e par d√©faut | Utilit√© principale                              |
| ------------------ | ---------------- | ----------------------------------------------- |
| Access             | 15 minutes       | Acc√®s rapide aux ressources prot√©g√©es           |
| Refresh            | 7 jours          | Renouvellement silencieux de l‚Äôaccess           |
| Reset mot de passe | 1 heure          | Validation courte d‚Äôun lien de r√©initialisation |
| CSRF               | 1 heure          | Protection des formulaires / mutations          |
 Ces valeurs peuvent √™tre surcharg√©es via les variables d‚Äôenvironnement correspondantes (JWT_ACCESS_EXPIRY, JWT_REFRESH_EXPIRY, etc.) sans toucher au code.






